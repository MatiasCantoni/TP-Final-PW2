<link rel="stylesheet" href="/assets/css/perfil.css">

<div class="container perfil-container">
    <div class="profile-header">
        <div class="profile-avatar">
            <img src="/{{usuario.foto_perfil}}" alt="Avatar" onerror="this.src='/assets/img/default-avatar.png'">
        </div>
        <div class="profile-info">
            <h1>{{usuario.nombre_completo}}</h1>
            <p class="username">@{{usuario.nombre_usuario}}</p>
            <div class="profile-meta">
                <span class="badge bg-primary">Ranking: #{{posicion}}</span>
                <span class="badge bg-success">{{usuario.pais}}, {{usuario.ciudad}}</span>
                <span class="badge bg-warning">Nivel: {{usuario.nivel}}</span>
            </div>
            
            {{#esPerfilPropio}}
            <button id="btn-editar" class="btn btn-sm btn-outline-light mt-3">Editar Perfil</button>

            <div id="vista-datos" class="profile-details mt-3">
                <div class="detail-item">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">{{usuario.email}}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">A√±o de Nacimiento:</span>
                    <span class="detail-value">{{usuario.anio_nacimiento}}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sexo:</span>
                    <span class="detail-value">{{usuario.sexo}}</span>
                </div>
                <div class="detail-item" style="display:block;">
                    <span class="detail-label">Ubicaci√≥n Actual:</span>
                    <div id="mapa-perfil" style="height: 200px; width: 100%; border-radius: 10px; margin-top: 10px; z-index: 0;"></div>
                </div>
            </div>

            <form id="form-editar" action="/perfil/actualizar" method="POST" class="profile-details mt-3" style="display:none;">
                <input type="hidden" name="id_usuario" value="{{usuario.id_usuario}}">
                
                <div class="mb-2">
                    <label class="form-label text-dark">Nombre Completo</label>
                    <input type="text" name="nombre_completo" class="form-control" value="{{usuario.nombre_completo}}" required>
                </div>

                <div class="mb-2">
                    <label class="form-label text-dark">A√±o de Nacimiento</label>
                    <input type="number" name="anio_nacimiento" class="form-control" value="{{usuario.anio_nacimiento}}" required>
                </div>

                <div class="mb-2">
                    <label class="form-label text-dark">Sexo</label>
                    <select name="sexo" class="form-control">
                        <option value="Masculino" {{#sexoMasculino}}selected{{/sexoMasculino}}>Masculino</option>
                        <option value="Femenino" {{#sexoFemenino}}selected{{/sexoFemenino}}>Femenino</option>
                        <option value="Prefiero no cargarlo" {{#sexoOtro}}selected{{/sexoOtro}}>Prefiero no cargarlo</option>
                    </select>
                </div>

                <input type="hidden" id="input-pais" name="pais" value="{{usuario.pais}}">
                <input type="hidden" id="input-ciudad" name="ciudad" value="{{usuario.ciudad}}">

                <div class="mb-2">
                    <label class="form-label text-dark">Cambiar Ubicaci√≥n (Click en el mapa)</label>
                    <div id="mapa-edicion" style="height: 250px; width: 100%; border-radius: 10px; z-index: 0;"></div>
                    <small class="text-muted" id="ubicacion-seleccionada">Actual: {{usuario.ciudad}}, {{usuario.pais}}</small>
                </div>

                <div class="d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-success flex-grow-1">Guardar Cambios</button>
                    <button type="button" id="btn-cancelar" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
            {{/esPerfilPropio}}
        </div>

        <div class="profile-qr">
            <div id="qrcode"></div>
            <p class="qr-label">Escanea para ver perfil</p>
        </div>
    </div>

    <div class="stats-section">
        <h2>üìä Estad√≠sticas</h2>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon">üéÆ</div>
                    <div class="stat-value">{{estadisticas.total_partidas}}</div>
                    <div class="stat-label">Partidas Jugadas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value">{{estadisticas.partidas_ganadas}}</div>
                    <div class="stat-label">Partidas Ganadas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value">{{estadisticas.preguntas_correctas}}</div>
                    <div class="stat-label">Respuestas Correctas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value">{{estadisticas.porcentaje_acierto}}%</div>
                    <div class="stat-label">% de Acierto</div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="stat-card puntaje-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value">{{usuario.puntaje_total}}</div>
                    <div class="stat-label">Puntaje M√°ximo</div>
                </div>
            </div>
        </div>
    </div>

    <div class="history-section">
        <h2> Historial de Partidas</h2>
        {{#partidas}}
        <div class="partida-card">
            <div class="partida-header">
                <span class="partida-modo">
                    {{#esSolitario}} Solitario{{/esSolitario}}
                    {{^esSolitario}} Versus{{/esSolitario}}
                </span>
                <span class="partida-fecha">{{fecha_fin_formateada}}</span>
            </div>
            <div class="partida-body">
                <div class="partida-stats">
                    <span class="stat-item">
                        <strong>{{respuestas_correctas}}</strong> / {{total_respuestas}} correctas
                    </span>
                    <span class="stat-item">
                        Puntaje: <strong>{{puntaje_obtenido}}</strong>
                    </span>
                </div>
                {{#oponente_nombre}}
                <div class="partida-oponente">
                    <small>vs {{oponente_nombre}}</small>
                    {{#esGanador}}
                        <span class="badge bg-success">Victoria</span>
                    {{/esGanador}}
                    {{^esGanador}}
                        <span class="badge bg-danger">Derrota</span>
                    {{/esGanador}}
                </div>
                {{/oponente_nombre}}
            </div>
        </div>
        {{/partidas}}
        
        {{^partidas}}
        <div class="no-partidas">
            <p>Este jugador a√∫n no ha jugado ninguna partida.</p>
        </div>
        {{/partidas}}
    </div>

    <div class="action-buttons">
        {{#esPerfilPropio}}
            <a href="/game/singleplayer" class="btn-custom mb-3">Jugar Ahora</a>
        {{/esPerfilPropio}}
        {{^esPerfilPropio}}
            <button class="btn btn-warning btn-lg" onclick="alert('Funcion para proxima entrega de TP')">
                ‚öîÔ∏è Desafiar
            </button>
        {{/esPerfilPropio}}
        <a href="/ranking/" class="btn-ranking mb-3">Ver Ranking</a>
        <a href="/inicio/" class="btn-inicio mb-3">Volver al Inicio</a>
    </div>
</div>

<script>
    const urlPerfil = "{{urlPerfil}}";
    const usuarioPais = "{{usuario.pais}}";
    const usuarioCiudad = "{{usuario.ciudad}}";
</script>