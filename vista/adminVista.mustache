<section class="contenedor-estadisticas container mt-5 border border-3 p-4 rounded">
    <h3 class=" text-center estadisticas">Estadísticas</h3>
    <div class="border p-2">
        <p><strong>Jugadores totales:</strong> {{jugadoresTotales}}</p>
        <p><strong>Total de partidas jugadas:</strong> {{partidasTotales}}</p>
        <p><strong>Cantidad de preguntas en el juego:</strong> {{preguntasTotales}}</p>
        <p><strong>Cantidad de preguntas creadas: </strong>{{preguntasCreadasTotales}}</p>
    </div>
</section>

<section class="contenedor-filtro container mt-5 border border-3 p-4 rounded">
    <h3 class="text-center">Filtrar Jugadores </h3>
    <div class="contenedor-selectores">
        <select name="filtro" id="filtro">
            <option value="pais">País</option>
            <option value="sexo">Sexo</option>
            <option value="edad">Edad</option>
        </select>

        <select name="tiempo" id="tiempo">
            <option value="dia">Día</option>
            <option value="semana">Semana</option>
            <option value="mes">Mes</option>
            <option value="anio">Año</option>
        </select>
    </div>
        <div id="chartContainer">
            <div id="grafico" style="width:100%; height:100%;"></div>
            <div id="totalCentro"
                style="">
        </div>
    </div>
</section>
<div class="container my-5 text-center">
    <a class="btn-custom mx-2 my-2" href="/user/logout">Cerrar sesión</a>
    <a class="btn-custom" href="/inicio/">Volver al Inicio</a>
</div>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    google.charts.load('current', {'packages':['corechart']});

    function dibujarGrafico(datos) {
        // Validamos que datos no sea nulo o vacio
        if (!datos || !Array.isArray(datos) || datos.length === 0) {
            document.getElementById('grafico').innerHTML = '<p>No hay datos disponibles</p>';
            document.getElementById("totalCentro").innerText = '';

            return;
        }

        const filtro = document.getElementById("filtro").value;

        let tituloColumna = "";
        switch (filtro) {
            case "pais": tituloColumna = "País"; break;
            case "sexo": tituloColumna = "Sexo"; break;
            case "edad": tituloColumna = "Edad"; break;
            default: tituloColumna = "Categoría";
        }
        // calculamos el total para despues ponerlo en el medio del grafico
        let total = datos.reduce((acc, row) => acc + parseInt(row.cantidad), 0);

        document.getElementById("totalCentro").innerText = `Total: ${total}`;

        const data = new google.visualization.DataTable();
        data.addColumn('string', tituloColumna);
        data.addColumn('number', 'Usuarios');

        datos.forEach(row => {
            data.addRow([ row.etiqueta, parseInt(row.cantidad) ]);
        });

        const options = {
            title: `Jugadores por ${tituloColumna}`,
            pieHole: 0.4,
            chartArea: { 
                width: '80%', 
                height: '80%' 
            },
            legend: {
                position: 'right',
                textStyle: { fontSize: 14 }
            }
        };

        const chart = new google.visualization.PieChart(
            document.getElementById('grafico')
        );
        
        chart.draw(data, options);
        posicionarTotalEnCentro();
    }

    function posicionarTotalEnCentro() {
        const svg = document.querySelector("#grafico svg");
        const totalDiv = document.getElementById("totalCentro");

        if (!svg) return;

        // Obtiene el "bounding box" del SVG (posición real del gráfico)
        const bbox = svg.getBoundingClientRect();
        const container = document.getElementById("chartContainer").getBoundingClientRect();

        // Calcula el centro real dentro del contenedor
        const centerX = bbox.left + bbox.width / 3.4 - container.left;
        const centerY = bbox.top + bbox.height / 2.2 - container.top;

        // Posiciona el total
        totalDiv.style.left = centerX + "px";
        totalDiv.style.top = centerY + "px";
        
    }    


    function actualizarGrafico(){
        const filtro = document.getElementById('filtro').value;
        const tiempo = document.getElementById('tiempo').value;

        console.log(`Obteniendo estadísticas: filtro=${filtro}, tiempo=${tiempo}`);

        fetch(`/admin/getEstadisticas?filtro=${filtro}&tiempo=${tiempo}`)
            .then(res => res.json())
            .then(data => {
                google.charts.setOnLoadCallback(function () {
                    dibujarGrafico(data);
                });
            });
    }

    google.charts.setOnLoadCallback(actualizarGrafico);

    document.getElementById('filtro').addEventListener('change', actualizarGrafico);
    document.getElementById('tiempo').addEventListener('change', actualizarGrafico);
    window.addEventListener('resize', actualizarGrafico);

    window.addEventListener('resize', () => {
    chart.draw(data, options);
    posicionarTotalEnCentro();
});
</script>